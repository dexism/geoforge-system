<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>運命を刻む元帳 ベンチャー of テイルズ TRPG(仮)</title>
    <link rel="stylesheet" href="rulebook.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
</head>
<body>

    <header class="site-header">
        <div class="header-inner">
            <button id="menu-btn" class="icon-btn" aria-label="メニューを開く">
                <span class="material-icons-round">menu</span>
            </button>
            <h1 class="site-logo"><a href="#">ベンチャー of テイルズ TRPG</a></h1>
            <button id="theme-toggle" class="icon-btn" aria-label="テーマ切り替え">
                <span class="material-icons-round">dark_mode</span>
            </button>
        </div>
    </header>

    <nav id="drawer-nav" class="drawer">
        <div class="drawer-header">
            <h2>目次</h2>
            <button id="close-menu-btn" class="icon-btn"><span class="material-icons-round">close</span></button>
        </div>
        
        <div class="external-links">
            <a href="https://docs.google.com/spreadsheets/d/1kX945WYVgjSfphGhsXcVXMuqt5awp85m4DUxconb_g4/edit?usp=sharing" target="_blank" class="nav-btn primary">
                <span class="material-icons-round">description</span> 履歴書 (Google Sheets)
            </a>
            <a href="https://geoforge-system.onrender.com/" target="_blank" class="nav-btn secondary">
                <span class="material-icons-round">public</span> GeoForge System
            </a>
        </div>

        <div id="toc-list" class="toc-list"></div>
    </nav>
    <div id="drawer-overlay" class="drawer-overlay"></div>

    <main class="main-container">
        <div id="content-area">
            <div class="loading">
                <div class="spinner"></div>
                <p>物語を読み込んでいます...</p>
            </div>
        </div>
    </main>

    <footer class="site-footer">
        <p>&copy; 2025 Candle's. All rights reserved.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const files = [
                'sections/01_introduction.html',
                'sections/02_player.html',
                'sections/03_teller.html',
                'sections/04_scenario.html',
                'sections/05_data.html'
            ];

            const contentArea = document.getElementById('content-area');
            const tocList = document.getElementById('toc-list');
            const drawer = document.getElementById('drawer-nav');
            const overlay = document.getElementById('drawer-overlay');
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = themeToggle.querySelector('span');

            // --- テーマ設定の初期化ロジック ---
            // 1. システムがダークモードを好んでいるか確認
            const prefersDarkScheme = window.matchMedia("(prefers-color-scheme: dark)");
            
            // 2. 以前の保存設定があればそれを優先、なければシステム設定に従う
            // (今回はlocalStorage実装は必須ではないですが、ページ遷移しても状態を保つために推奨)
            const currentTheme = localStorage.getItem("theme");

            if (currentTheme === "dark" || (!currentTheme && prefersDarkScheme.matches)) {
                document.body.classList.add("dark-mode");
                themeIcon.textContent = "light_mode";
            } else {
                document.body.classList.remove("dark-mode");
                themeIcon.textContent = "dark_mode";
            }

            // ダークモード切り替えボタンの処理
            themeToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                const isDark = document.body.classList.contains('dark-mode');
                themeIcon.textContent = isDark ? 'light_mode' : 'dark_mode';
                // 設定を保存
                localStorage.setItem("theme", isDark ? "dark" : "light");
            });
            // -----------------------------------

            let articles = [];

            Promise.all(files.map(file => fetch(file).then(res => {
                if (!res.ok) throw new Error(`Failed to load ${file}`);
                return res.text();
            })))
            .then(htmlContents => {
                const fullHtml = htmlContents.join('');
                parseAndIndexContent(fullHtml);
                router();
            })
            .catch(err => {
                console.error(err);
                contentArea.innerHTML = `<div class="error-msg" style="padding: 2rem; text-align: center;">
                    <h3>読み込みエラー</h3>
                    <p>コンテンツを読み込めませんでした。</p>
                </div>`;
            });

            function parseAndIndexContent(html) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const targetSelector = 'section[id], article[id]';
                const allElements = Array.from(doc.querySelectorAll(targetSelector));
                
                articles = allElements.map((el, index) => {
                    const titleEl = el.querySelector('h1, h2, h3');
                    const title = titleEl ? titleEl.textContent.trim() : '無題';
                    const id = el.id;
                    const level = titleEl ? parseInt(titleEl.tagName.substring(1)) : 2;

                    const clone = el.cloneNode(true);
                    // 子要素として含まれるsection/articleを削除（これが分割のキモ）
                    const nestedTargets = clone.querySelectorAll(targetSelector);
                    nestedTargets.forEach(child => child.remove());
                    
                    const content = clone.innerHTML;
                    
                    return { index, id, title, level, content };
                });

                generateTOC();
            }

            function generateTOC() {
                let html = '<ul>';
                articles.forEach(article => {
                    const indentClass = `level-${article.level}`;
                    html += `<li class="${indentClass}">
                        <a href="#${article.id}" onclick="closeDrawer()">
                            ${article.title}
                        </a>
                    </li>`;
                });
                html += '</ul>';
                tocList.innerHTML = html;
            }

            window.addEventListener('hashchange', router);

            function router() {
                const hash = window.location.hash.substring(1);
                
                if (!hash) {
                    if(articles.length > 0) renderArticle(articles[0]);
                } else {
                    const targetArticle = articles.find(a => a.id === hash);
                    if (targetArticle) renderArticle(targetArticle);
                    else contentArea.innerHTML = '<p style="padding:2rem;">指定された記事が見つかりません。</p>';
                }
                window.scrollTo(0, 0);
            }

            function renderArticle(article) {
                const prev = articles[article.index - 1];
                const next = articles[article.index + 1];

                let html = `
                    <article class="blog-post fade-in">
                        <div class="post-content">
                            ${article.content}
                        </div>
                    </article>
                    
                    <nav class="post-nav">
                        ${prev ? `<a href="#${prev.id}" class="nav-card prev">
                            <span class="label">前の記事</span>
                            <span class="title">${prev.title}</span>
                        </a>` : '<span></span>'}
                        
                        ${next ? `<a href="#${next.id}" class="nav-card next">
                            <span class="label">次の記事</span>
                            <span class="title">${next.title}</span>
                        </a>` : '<span></span>'}
                    </nav>
                `;
                contentArea.innerHTML = html;
            }

            const menuBtn = document.getElementById('menu-btn');
            const closeMenuBtn = document.getElementById('close-menu-btn');
            // const drawer = document.getElementById('drawer-nav');
            // const overlay = document.getElementById('drawer-overlay');

            function openDrawer() {
                drawer.classList.add('open');
                overlay.classList.add('open');
            }
            window.closeDrawer = function() { 
                drawer.classList.remove('open');
                overlay.classList.remove('open');
            };

            menuBtn.addEventListener('click', openDrawer);
            closeMenuBtn.addEventListener('click', closeDrawer);
            overlay.addEventListener('click', closeDrawer);
        });
    </script>
</body>
</html>